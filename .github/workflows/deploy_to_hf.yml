name: Deploy to Hugging Face Spaces

on:
  # 当代码推送到 main 分支时触发
  push:
    branches:
      - main

jobs:
  build-and-push-to-hf:
    runs-on: ubuntu-latest
    steps:
      # 步骤 1: 检出代码
      # 使用 lfs: true 来确保 Git LFS 文件被正确拉取
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      # 步骤 2: 登录到 Hugging Face Docker Registry
      # 您需要在 GitHub 仓库的 Secrets 中设置 HF_USERNAME 和 HF_TOKEN
      # HF_USERNAME 是您的 Hugging Face 用户名
      # HF_TOKEN 是一个具有 write 权限的 Hugging Face Access Token
      - name: Login to Hugging Face Registry
        uses: docker/login-action@v3
        with:
          registry: registry.hf.space
          username: ${{ secrets.HF_USERNAME }}
          password: ${{ secrets.HF_TOKEN }}

      # 步骤 3: 使用 Docker CLI 构建并推送镜像
      # 我们直接使用 docker 命令来绕过 build-push-action 的自动小写问题
      - name: Build and Push with Docker CLI
        run: |
          # 定义镜像标签，直接使用 Secret，保持大小写
          IMAGE_TAG="registry.hf.space/${{ secrets.HF_SPACE_NAME }}:latest"
          
          # 构建镜像
          echo "Building image with tag: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" .
          
          # 推送镜像
          echo "Pushing image to Hugging Face Hub"
          docker push "$IMAGE_TAG"